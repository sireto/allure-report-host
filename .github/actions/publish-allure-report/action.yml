name: 'Publish Allure Report'
id: upload-allure
description: 'Uploads an Allure report to the central report host'
inputs:
  serverUrl:
    description: 'API endpoint for report upload'
    required: true
  serverApiKey:
    description: 'API key for authentication'
    required: true
  projectName:
    description: 'Project name'
    required: true
  branch:
    description: 'Branch name'
    required: true
  reportName:
    description: 'Report name'
    required: true
  reportType:
    description: 'Report type (allure/raw)'
    required: false
    default: 'allure'
  path:
    description: 'Path to allure-results or zip'
    required: true
  testResult:
    description: 'Test result exit code (0=success, nonzero=failure)'
    required: false 
  testsPassed:
    description: 'Number of passed tests'
    required: false
  testsFailed:
    description: 'Number of failed tests'
    required: false
runs:
  using: "composite"
  steps:
    - run: |
        bash ./scripts/publish-report.sh \
          --url "${{ inputs.serverUrl }}" \
          --key "${{ inputs.serverApiKey }}" \
          "${{ inputs.projectName }}" \
          "${{ inputs.branch }}" \
          "${{ inputs.reportName }}" \
          "${{ inputs.reportType }}" \
          "${{ inputs.path }}"
      shell: bash

    - name: Publish Allure Report
      timeout-minutes: 12
      continue-on-error: true
      env:
        API_SECRET:   ${{ secrets.API_KEY }}
        SERVER_URL:   ${{ vars.STAGING_SERVER_URL }}

      uses: sireto/allure-report-host@v1.2
      with:
        path: ./allure-results

    - name: Set commit status with Allure summary
      if: always()
      uses: actions/github-script@v6
      with:
        script: |
          let sha = context.eventName === 'workflow_dispatch'
            ? github.context.sha
            : (context.payload.workflow_run
              ? context.payload.workflow_run.head_sha
              : github.context.sha);

          // Determine state & description
          const uploadOutcome = "${{ steps.upload-allure.outcome || 'timeout' }}";

          let state = 'neutral';
          let description = 'Allure report processing unknown';

          if (uploadOutcome === 'success') {
            state = 'success';
            description = 'Allure report uploaded successfully';
          } else if (uploadOutcome === 'failure') {
            state = 'failure';
            description = 'Allure report upload failed';
          } else if (uploadOutcome === 'timeout' || uploadOutcome === 'cancelled') {
            state = 'error';
            description = 'Allure report upload timed out or was cancelled';
          }

          const details = [
            description,
            `Passed:  ${{ steps.run_tests.outputs.passed  || 'unknown' }}`,
            `Failed:  ${{ steps.run_tests.outputs.failed  || 'unknown' }}`,
            "",
            "View report → ${{ vars.STAGING_SERVER_URL }}/${{ github.repository }}/${{ github.ref_name }}/${{ github.run_id }}/index.html"
          ].join('\n');

          await github.rest.repos.createCommitStatus({
            owner: context.repo.owner,
            repo: context.repo.repo,
            sha: sha,
            state: state,
            context: 'allure-report',
            description: description,
            target_url: `${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}`,
          });

          console.log(`Set commit status → ${state} / ${description}`);