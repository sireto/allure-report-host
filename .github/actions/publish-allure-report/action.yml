name: 'Publish Allure Report'
description: 'Uploads an Allure report to the central report host'
inputs:
  serverUrl:
    description: 'API endpoint for report upload'
    required: true
  serverApiKey:
    description: 'API key for authentication'
    required: true
  projectName:
    description: 'Project name'
    required: true
  branch:
    description: 'Branch name'
    required: true
  reportName:
    description: 'Report name'
    required: true
  reportType:
    description: 'Report type (allure/raw)'
    required: false
    default: 'allure'
  path:
    description: 'Path to allure-results or zip'
    required: true
  githubToken:
    description: 'GitHub token for setting commit status'
    required: false
  testResult:
    description: 'Test result exit code (0=success, nonzero=failure)'
    required: false 
  testsPassed:
    description: 'Number of passed tests'
    required: false
  testsFailed:
    description: 'Number of failed tests'
    required: false
runs:
  using: "composite"
  steps:
    - run: |
        bash ./scripts/publish-report.sh \
          --url "${{ inputs.serverUrl }}" \
          --key "${{ inputs.serverApiKey }}" \
          "${{ inputs.projectName }}" \
          "${{ inputs.branch }}" \
          "${{ inputs.reportName }}" \
          "${{ inputs.reportType }}" \
          "${{ inputs.path }}"
      shell: bash

    - name: Set commit status
      if: ${{ inputs.githubToken }}
      run: |
        commit_sha="${GITHUB_SHA:-$(git rev-parse HEAD)}"
        context="${{ inputs.reportName }}"
        target_url="${{ inputs.serverUrl }}/${{ inputs.projectName }}/${{ inputs.branch }}/${{ inputs.reportName }}/index.html"
        if [[ -n "${{ inputs.testsPassed }}" && -n "${{ inputs.testsFailed }}" ]]; then
          description="Passed ${{ inputs.testsPassed }}, Failed ${{ inputs.testsFailed }}"
        else
          description="Allure report for this build"
        fi
        if [[ -n "${{ inputs.testResult }}" ]]; then
          if [[ "${{ inputs.testResult }}" == "0" ]]; then
            state="success"
          else
            state="failure"
          fi
        else
          state="success"
        fi
        curl -s -X POST \
          -H "Authorization: token ${{ inputs.githubToken }}" \
          -H "Content-Type: application/json" \
          -d "{\"state\": \"${state}\", \"target_url\": \"${target_url}\", \"description\": \"${description}\", \"context\": \"${context}\"}" \
          "https://api.github.com/repos/${GITHUB_REPOSITORY}/statuses/${commit_sha}"
      shell: bash